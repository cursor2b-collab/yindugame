# æ¸¸æˆæ¥å£ä¿®å¤è¯´æ˜

## ğŸ“‹ ä¿®å¤æ¦‚è¿°

æŒ‰ç…§ `tongmeng-main` é¡¹ç›®çš„å®ç°æ–¹å¼ï¼Œä¿®å¤äº† `gamex` é¡¹ç›®çš„æ¸¸æˆæ¥å£ï¼Œç¡®ä¿ä¸¤ä¸ªé¡¹ç›®çš„æ¥å£è°ƒç”¨æ–¹å¼ä¿æŒä¸€è‡´ã€‚

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. **åˆ›å»ºè¯­è¨€æ˜ å°„å·¥å…·** (`src/utils/languageMapper.ts`)

- âœ… åˆ›å»ºäº†å®Œæ•´çš„è¯­è¨€ä»£ç æ˜ å°„å·¥å…·
- âœ… æ”¯æŒä» `localStorage.getItem('ly_lang')` è‡ªåŠ¨è·å–è¯­è¨€å¹¶æ˜ å°„
- âœ… æ”¯æŒå¤šç§è¯­è¨€æ ¼å¼ï¼ˆzh_cn, zh-CN, en_us ç­‰ï¼‰
- âœ… é»˜è®¤æ˜ å°„åˆ°æ¸¸æˆæ¥å£æ”¯æŒçš„è¯­è¨€ä»£ç 

### 2. **æ›´æ–°æ¸¸æˆAPIæœåŠ¡** (`src/services/gameApiService.ts`)

#### API URL é…ç½®
- âœ… æ›´æ–°ä¸ºä¸ `tongmeng-main` ä¸€è‡´çš„é…ç½®æ–¹å¼
- âœ… å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ `/api`ï¼ˆé€šè¿‡ Vite ä»£ç†ï¼‰
- âœ… ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨å®Œæ•´URL `https://api.xpj66666.com/api`

#### Token è·å–
- âœ… ä¼˜å…ˆä½¿ç”¨ `localStorage.getItem('token')`ï¼ˆä¸ tongmeng-main ä¸€è‡´ï¼‰
- âœ… å…¼å®¹ `sessionStorage.getItem('token')`
- âœ… å‘åå…¼å®¹ `auth_token` å’Œ `access_token`

#### è¶…æ—¶å¤„ç†
- âœ… æ·»åŠ 30ç§’è¯·æ±‚è¶…æ—¶å¤„ç†
- âœ… å®Œå–„çš„è¶…æ—¶é”™è¯¯æç¤º

#### é”™è¯¯å¤„ç†
- âœ… æ·»åŠ  422 éªŒè¯é”™è¯¯çš„è¯¦ç»†å¤„ç†
- âœ… å®Œå–„çš„ç½‘ç»œé”™è¯¯æ£€æµ‹ï¼ˆCORSã€è¶…æ—¶ç­‰ï¼‰
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

#### è¯­è¨€å‚æ•°è‡ªåŠ¨è·å–
- âœ… `getGamesList()` - è‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„è¯­è¨€
- âœ… `getMiniGamesList()` - è‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„è¯­è¨€
- âœ… `getLaunchUrl()` - è‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„è¯­è¨€

#### ç”¨æˆ·ä½™é¢API
- âœ… `getUserBalance()` - æ”¯æŒå¯é€‰çš„ `vendorCode` å‚æ•°ï¼ˆåˆ†ç¦»é’±åŒ…ï¼‰

#### åˆ›å»ºç”¨æˆ·æ–¹æ³•
- âœ… å®Œå–„çš„å‚æ•°éªŒè¯
- âœ… è¯¦ç»†çš„ errorCode å¤„ç†ï¼ˆ0=æˆåŠŸï¼Œ1=ç”¨æˆ·å·²å­˜åœ¨ï¼‰
- âœ… ä¸ tongmeng-main å®Œå…¨ä¸€è‡´çš„å®ç°

### 3. **æ›´æ–°è®¤è¯æœåŠ¡** (`src/services/authService.ts`)

#### API URL é…ç½®
- âœ… æ›´æ–°ä¸ºä¸ `tongmeng-main` ä¸€è‡´çš„é…ç½®æ–¹å¼

#### Token ç®¡ç†
- âœ… ç™»å½•æ—¶ä¿å­˜åˆ° `localStorage.setItem('token')`ï¼ˆä¸»è¦keyï¼‰
- âœ… åŒæ—¶ä¿å­˜åˆ° `sessionStorage.setItem('token')`
- âœ… å‘åå…¼å®¹ `auth_token` å’Œ `access_token`
- âœ… ç™»å‡ºæ—¶æ¸…é™¤æ‰€æœ‰token key

#### Token è·å–
- âœ… ä¼˜å…ˆä½¿ç”¨ `localStorage.getItem('token')`
- âœ… å…¼å®¹å¤šç§token key

### 4. **æ›´æ–°æ¸¸æˆAPI Hook** (`src/hooks/useGameApi.ts`)

#### è·å–ç”¨æˆ·ä»£ç 
- âœ… ä¼˜å…ˆä» `localStorage.getItem('userInfo')` è·å–ï¼ˆå‚è€ƒ tongmeng-mainï¼‰
- âœ… æ”¯æŒ `id`, `user_id`, `username` å­—æ®µ
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†

#### è·å–æ¸¸æˆåˆ—è¡¨
- âœ… `language` å‚æ•°æ”¹ä¸ºå¯é€‰
- âœ… ä¸ä¼ é€’æ—¶è‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„

#### å¯åŠ¨æ¸¸æˆï¼ˆå®Œæ•´å®ç°ï¼Œå‚è€ƒ tongmeng-mainï¼‰
- âœ… `language` å‚æ•°æ”¹ä¸ºå¯é€‰ï¼Œä¸ä¼ é€’æ—¶è‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„
- âœ… **ä¾›åº”å•†éªŒè¯**ï¼šä»ä¾›åº”å•†åˆ—è¡¨è·å–å¹¶éªŒè¯ vendorCode
- âœ… **è‡ªåŠ¨åˆ›å»ºç”¨æˆ·**ï¼šå¯åŠ¨æ¸¸æˆå‰è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- âœ… **è‡ªåŠ¨è½¬å…¥ä½™é¢**ï¼šå¯åŠ¨æ¸¸æˆå‰è‡ªåŠ¨å°†é’±åŒ…ä½™é¢è½¬å…¥æ¸¸æˆè´¦æˆ·
  - è·å–ç”¨æˆ·é’±åŒ…ä½™é¢ï¼ˆä¼˜å…ˆä½¿ç”¨ `money` å­—æ®µï¼Œç„¶åæ˜¯ `balance` å­—æ®µï¼‰
  - è·å–æ¸¸æˆä¸­çš„ä½™é¢
  - è®¡ç®—éœ€è¦è½¬å…¥çš„é‡‘é¢ï¼ˆé’±åŒ…ä½™é¢ - æ¸¸æˆä¸­ä½™é¢ï¼‰
  - æ‰§è¡Œè½¬å…¥æ“ä½œï¼ˆå¦‚æœé‡‘é¢ > 0ï¼‰
- âœ… **lobbyUrl è‡ªåŠ¨æ„å»º**ï¼šè‡ªåŠ¨æ£€æµ‹ç§»åŠ¨ç«¯å¹¶æ„å»ºæ­£ç¡®çš„ lobbyUrl

### 5. **æ›´æ–°ä¸»åº”ç”¨ç»„ä»¶** (`src/App.tsx`)

- âœ… ç§»é™¤ç¡¬ç¼–ç çš„ `'zh'` è¯­è¨€å‚æ•°
- âœ… è®© API è‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„è¯­è¨€
- âœ… æ¸¸æˆå¯åŠ¨æ—¶ä¹Ÿä½¿ç”¨è‡ªåŠ¨è¯­è¨€æ˜ å°„

---

## ğŸ”§ å…³é”®æ”¹è¿›

### 1. **è¯­è¨€è‡ªåŠ¨æ˜ å°„**

```typescript
// ä¹‹å‰ï¼šç¡¬ç¼–ç è¯­è¨€
await fetchGamesFromApi(vendorCode, 'zh')

// ç°åœ¨ï¼šè‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„
await fetchGamesFromApi(vendorCode)  // è‡ªåŠ¨ä½¿ç”¨ getGameApiLanguage()
```

### 2. **è‡ªåŠ¨è½¬å…¥ä½™é¢ï¼ˆå…³é”®åŠŸèƒ½ï¼‰**

å¯åŠ¨æ¸¸æˆå‰ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼ˆå‚è€ƒ tongmeng-mainï¼‰ï¼š

1. **è·å–ç”¨æˆ·é’±åŒ…ä½™é¢**
   ```typescript
   const userInfo = await authService.getCurrentUser();
   const walletBalance = userInfo?.money || userInfo?.balance || 0;
   ```

2. **è·å–æ¸¸æˆä¸­çš„ä½™é¢**
   ```typescript
   const balanceResponse = await gameApiService.getUserBalance(userCode, vendorCode);
   const gameBalance = parseFloat(balanceResponse.message || '0') || 0;
   ```

3. **è®¡ç®—å¹¶è½¬å…¥ä½™é¢**
   ```typescript
   const transferAmount = walletBalance - gameBalance;
   if (transferAmount > 0) {
     await gameApiService.deposit(userCode, transferAmount, orderNo, vendorCode);
   }
   ```

### 3. **ä¾›åº”å•†éªŒè¯**

å¯åŠ¨æ¸¸æˆå‰ä¼šè‡ªåŠ¨éªŒè¯ vendorCode æ˜¯å¦å­˜åœ¨äºä¾›åº”å•†åˆ—è¡¨ä¸­ï¼š

```typescript
const vendorsResponse = await gameApiService.getVendorsList();
const foundVendor = vendors.find((v: any) => v.vendorCode === vendorCode);
if (!foundVendor) {
  // å°è¯•æ ¹æ®åç§°åŒ¹é…
  // å¦‚æœæ‰¾ä¸åˆ°ï¼Œä½¿ç”¨åŸå€¼å¹¶è®°å½•è­¦å‘Š
}
```

### 2. **Token ç®¡ç†ç»Ÿä¸€**

```typescript
// ç°åœ¨æ”¯æŒå¤šç§token keyï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
const token = localStorage.getItem('token') ||           // ä¸»è¦keyï¼ˆtongmeng-mainä½¿ç”¨ï¼‰
              sessionStorage.getItem('token') ||         // ä¼šè¯key
              localStorage.getItem('auth_token') ||      // å…¼å®¹key
              localStorage.getItem('access_token')       // å…¼å®¹key
```

### 3. **API URL é…ç½®**

```typescript
// å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡ Vite ä»£ç†ï¼‰
const apiBaseUrl = import.meta.env.VITE_API_URL || 
  (import.meta.env.DEV ? '/api' : 'https://api.xpj66666.com/api')
```

### 4. **é”™è¯¯å¤„ç†å¢å¼º**

- âœ… 30ç§’è¯·æ±‚è¶…æ—¶
- âœ… CORS é”™è¯¯æ£€æµ‹
- âœ… 422 éªŒè¯é”™è¯¯è¯¦ç»†æç¤º
- âœ… ç½‘ç»œé”™è¯¯è¯¦ç»†æ—¥å¿—

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### è·å–æ¸¸æˆåˆ—è¡¨ï¼ˆè‡ªåŠ¨è¯­è¨€æ˜ å°„ï¼‰

```typescript
import { useGameApi } from '@/hooks/useGameApi';

const { fetchGames } = useGameApi();

// ä¸ä¼ é€’ languageï¼Œè‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„
const games = await fetchGames('slot-pgsoft');
```

### å¯åŠ¨æ¸¸æˆï¼ˆè‡ªåŠ¨è¯­è¨€æ˜ å°„ï¼‰

```typescript
import { useGameApi } from '@/hooks/useGameApi';

const { launchGame } = useGameApi();

// ä¸ä¼ é€’ languageï¼Œè‡ªåŠ¨ä» localStorage è·å–å¹¶æ˜ å°„
await launchGame('slot-pgsoft', 'P060', undefined, null);
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `src/utils/languageMapper.ts` - è¯­è¨€æ˜ å°„å·¥å…·ï¼ˆæ–°å¢ï¼‰
- `src/services/gameApiService.ts` - æ¸¸æˆAPIæœåŠ¡ï¼ˆå·²æ›´æ–°ï¼‰
- `src/services/authService.ts` - è®¤è¯æœåŠ¡ï¼ˆå·²æ›´æ–°ï¼‰
- `src/hooks/useGameApi.ts` - æ¸¸æˆAPI Hookï¼ˆå·²æ›´æ–°ï¼‰
- `src/App.tsx` - ä¸»åº”ç”¨ç»„ä»¶ï¼ˆå·²æ›´æ–°ï¼‰

---

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

```env
# APIåŸºç¡€URLï¼ˆå¯é€‰ï¼‰
VITE_API_URL=https://api.xpj66666.com/api

# å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨ï¼š
# - å¼€å‘ç¯å¢ƒï¼š/apiï¼ˆé€šè¿‡ Vite ä»£ç†ï¼‰
# - ç”Ÿäº§ç¯å¢ƒï¼šhttps://api.xpj66666.com/api
```

---

## ğŸ“Œ é‡è¦æç¤º

1. **è¯­è¨€è‡ªåŠ¨æ˜ å°„**ï¼šæ‰€æœ‰æ¸¸æˆAPIè°ƒç”¨ç°åœ¨ä¼šè‡ªåŠ¨ä» `localStorage.getItem('ly_lang')` è·å–è¯­è¨€å¹¶æ˜ å°„
2. **Token å…¼å®¹æ€§**ï¼šæ”¯æŒå¤šç§token keyï¼Œç¡®ä¿ä¸ä¸åŒé¡¹ç›®å…¼å®¹
3. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•
4. **è¶…æ—¶å¤„ç†**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½æœ‰30ç§’è¶…æ—¶ä¿æŠ¤
5. **å‘åå…¼å®¹**ï¼šä¿æŒå¯¹æ—§ä»£ç çš„å…¼å®¹æ€§

---

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼Œ`gamex` é¡¹ç›®çš„æ¸¸æˆæ¥å£ç°åœ¨ä¸ `tongmeng-main` é¡¹ç›®ä¿æŒä¸€è‡´ï¼
